---
layout: post
title:      "PBOC流程解析(十一)  PBOC电子现金"
subtitle:   "POS规范 -- IC卡操作流程"
tags:       [IC ,PBOC]
mathjax:    false
date:       2016-10-31
author:     "Undefined"
description: ""
header-img: "/img/tags-bg.jpg"
---

## 目录
{: .no_toc}

* 目录
{:toc}

> `详细查看规范第13部分`

接触式电子现金同样走的还是`PSE`..相比PBOC完整流程`少了处理限制及持卡人验证`(规范上面是这样),
我看代码好像加了这两个步骤
,确实导致很多卡走到输入密码的过程去了(持卡人认证导致的联机)..个人觉得这是不对的.

---


## (一)文档说明

<p><img src=""></p>
<p><img src=""></p>

## (二)资料解析




## (三)源码片段分析


## (四)常见问题及分析

这里转载自[技术为王](http://blog.csdn.net/pony_maggie/article/details/43711773)的博客:

> 1.电子现金联机的情况

<p>1. 卡片收到GPO的命令，分析不满足电子现金的条件，也就是下面几个条件中任意一个不满足:</p>
	1 命令中包含电子现金终端支持指示器（设置为“1”）；  
    2 交易货币代码与应用货币代码匹配；  
    3 授权金额不超过电子现金余额；  
    4 授权金额不超过电子现金单笔交易限额；  
    5 发卡行认证失败指示器为“0”；  
    6 上次联机交易发卡行脚本处理失败指示器为“0”；  
    7 PIN 尝试次数不为“0”  
**这种情况严格来说不算是电子现金转联机，毕竟从应用初始化开始都是借贷记流程了**

<p>2. 卡片在GPO阶段对电子现金条件的<code>检查通过</code>，卡片认为可以进行电子现金交易，这个时候会返回电子现金的AFL。
终端在读完记录后，会做脱机认证，一般是SDA或DDA，
<code>脱机认证如果失败或未执行</code>，通常也会联机。
注意这种联机并不是在脱机认证阶段发起的，脱机认证失败后，终端会置上TVR相应的位</p>

<p>3.卡片在GPO阶段对电子现金条件的检查通过，卡片认为可以进行电子现金交易，
这个时候会返回电子现金的AFL。终端脱机认证也成功。终端行为分析阶段，
<code>电子现金余额减去授权金额的差值小于重置阈值</code>, 终端会请求联机，
并且如果终端带有密码键盘，还有要求输入联机pin。
为什么要输入联机pin，这个和实际的应用场景有关，重置阈值一般是用来触发自动圈存的，记得上大学时用饭卡，可以设置一个金额，当余额小于这个金额时自动圈存。这个金额其实就是电子现金重置阈值的概念。既然是圈存，肯定是要输入主账户密码的。
</p>
 <p>4.<code>终端的强制联机功能打开</code>，这表示商户要求所有的交易强制联机，属于收单行的一种行为。跟实际的应用场景有关。
<p>
 
 ---
 
 