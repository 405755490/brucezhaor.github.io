---
layout: post
title:      "PBOC流程解析(十一)  PBOC电子现金"
subtitle:   "POS规范 -- IC卡操作流程"
tags:       [IC ,PBOC]
mathjax:    false
date:       2016-10-31
author:     "Undefined"
description: ""
header-img: "/img/tags-bg.jpg"
categories:  [PBOC]
---

## 目录
{: .no_toc}

* 目录
{:toc}

> **`详细查看规范第13部分`**


## (一)文档说明

<p>B.1.2  功能描述 </p>

当持卡人将具有电子现金功能的金融IC卡插入POS终端时，按照JR/T 0025所描述的，终端选择卡应
用。与JR/T 0025一致，终端也执行一系列操作，包括检查卡是否真实[卡片认证方法（CAM）]，以及持
卡人是否真实[持卡人验证方法（CVM）]。具体步骤参看第六部分或者之前的文章...

`这个步骤出现很大可能在持卡人认证的时候返回联机..走到输入密码的步骤去了`,主要参看CVM的值。
常见的情况是是<kbd>0203(联机),1E03或者4E03(签名)</kbd>

<p></p>

**7.4.1  应用选择** 


终端发送SELECT命令选择应用，卡片返回文件控制信息（FCI），其中包括了请求电子现金终端支持指示器（9F7A）、授权金额（9F02）以及交易货币代码（5F2A）的PDOL。 

**7.4.2  初始化应用**

<kbd>如果满足以下条件： </kbd>

——  终端支持电子现金交易；
 
——  授权金额小于电子现金终端交易限额，或者在终端不包括单独的电子现金终端交易限额的情况下，小于终端最低限额； 

——  终端交易类型为消费交易。
 
那么，终端将在GPO命令中提供电子现金终端支持指示器（设置为“1”）。
 
当收到GPO命令时，如果以下条件满足，卡片将此交易看作一个电子现金交易：

`——  命令中包含电子现金终端支持指示器（设置为“1”）；`
 
`——  交易货币代码与应用货币代码匹配； `

`——  授权金额不超过电子现金余额； `

`——  授权金额不超过电子现金单笔交易限额； `

`——  发卡行认证失败指示器为“0”； `

`——  上次联机交易发卡行脚本处理失败指示器为“0”；`
 
`——  PIN尝试次数不为“0”。 `

如果以上任一条件不满足，交易就不是一个电子现金交易。 

如果此次交易被卡片看作是一笔电子现金交易，那么卡片应当： 

`——  标识本次交易为电子现金交易； `

`——  返回 GPO 响应数据 AIP 和 AFL，`AIP 指示电子现金交易支持的功能，AFL 则指明了电子现金特定数据——电子现金发卡行授权码的位置。 
如果此次交易不是电子现金交易，卡片在GPO的响应中返回非电子现金的AIP和AFL（不返回电子现金发卡行授权码），终端将此交易当作标准借记/贷记交易处理。 
当终端收到AIP和AFL，且电子现金发卡行授权码存在，则用GET DATA命令读取如下数据： 

`——  电子现金余额； `

`——  电子现金重置阈值。` 

如果终端没有收到AIP和AFL，则交易被终止。 


## (二)资料解析

本章详细描述用于控制具有电子现金功能的金融IC卡的常用命令： 

——  电子现金余额查询； 
	发送: 80 CA 9F 79 00
	返回: 9F7906余额

——  交易日志查询； 

——  取交易日志格式命令； 

——  更新电子现金参数命令。 

`接触式电子现金也需要持卡人认证,图7.5所示的流程没有写出来...`



## (三)源码片段分析





## (四)常见问题及分析

这里转载自[技术为王](http://blog.csdn.net/pony_maggie/article/details/43711773)的博客:

### 1.电子现金联机的情况

<p>1. 卡片收到GPO的命令，分析不满足电子现金的条件，也就是下面几个条件中任意一个不满足:</p>
	1 命令中包含电子现金终端支持指示器（设置为“1”）；  
    2 交易货币代码与应用货币代码匹配；  
    3 授权金额不超过电子现金余额；  
    4 授权金额不超过电子现金单笔交易限额；  
    5 发卡行认证失败指示器为“0”；  
    6 上次联机交易发卡行脚本处理失败指示器为“0”；  
    7 PIN 尝试次数不为“0”  
    
**这种情况严格来说不算是电子现金转联机，毕竟从应用初始化开始都是借贷记流程了**

<p>2. 卡片在GPO阶段对电子现金条件的<code>检查通过</code>，卡片认为可以进行电子现金交易，这个时候会返回电子现金的AFL。
终端在读完记录后，会做脱机认证，一般是SDA或DDA，
<code>脱机认证如果失败或未执行</code>，通常也会联机。
注意这种联机并不是在脱机认证阶段发起的，脱机认证失败后，终端会置上TVR相应的位</p>

<p>3.卡片在GPO阶段对电子现金条件的检查通过，卡片认为可以进行电子现金交易，
这个时候会返回电子现金的AFL。终端脱机认证也成功。终端行为分析阶段，
<code>电子现金余额减去授权金额的差值小于重置阈值</code>, 终端会请求联机，
并且如果终端带有密码键盘，还有要求输入联机pin。
为什么要输入联机pin，这个和实际的应用场景有关，重置阈值一般是用来触发自动圈存的，记得上大学时用饭卡，可以设置一个金额，当余额小于这个金额时自动圈存。这个金额其实就是电子现金重置阈值的概念。既然是圈存，肯定是要输入主账户密码的。
</p>
 <p>4.<code>终端的强制联机功能打开</code>，这表示商户要求所有的交易强制联机，属于收单行的一种行为。跟实际的应用场景有关。
</p>
 
***
 
 