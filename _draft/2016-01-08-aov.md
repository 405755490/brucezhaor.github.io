---
layout: post
title: 方差分析：穷人家的孩子学不好？
subtitle: 重新认识方差分析
categories : [statistics]
tags : [aov]
date: 2016-1-7
author: "赵炜"
header-img: "/img/post/aov-bg.png"
description: "总有学校说，我们乡下地方，孩子读书的条件差，肯定考不过城里孩子的...那么？事实真的是这样吗？"
output: 
  html_document: 
    css: ~/GitHub/brucezhaor.github.io/assets/css/style.css
---

 
与统计和数据分析打交道的人，想必对`方差分析`一点都不陌生，但是真正懂得其原理的人又有多少呢？在写这篇文章之前，作为统计学专业毕业的人，表示对方差分析也只是一知半解，有时候还会出现误用的情况。为了写这篇文章，我又重拾《数理统计》这本书，经过一番推导和查阅相关资料后，总算是有了一定的了解。于是打算写这么一篇文章来与大家分享方差分析的原理以及用法，最后给出实际的例子。

## 背景知识

### 原理与推导

> 没有公式就没有伤害   

为了不给大家造成伤害，我尽量不照搬公式，用人话来解释清楚。

#### 方差分析的起源 

一般两个样本的均值检验，现实中最常用的是**t检验**。因为t检验具有具有以下性质： 

* 两总体方差未知时，可以使用；
* 非正态总体，大样本情况下可以使用；

而**Z检验**（又叫U检验）的前提条件就是两样本的**总体方差已知**，一般情况下总体的方差是不知道的，用样本的方差去估计个人认为偏差很大，所以Z建议现实生活中基本用不上。当然，如果你精通抽样技术（很难），能够计算无偏的总体方差估计，想必早就对这些基本方法不屑一顾了。

刚说了**t检验**只适用于两个样本的均值检验，那如果涉及到多个样本的均值检验呢？有人说:“两两t检验不就行了吗，虽然麻烦了一点，但还不是能做出来的，根本用不着新方法吧。” 

假设有三个样本要对其均值进行检验是否相等，那么就要比较 $$C_3^2 = 3$$ 次了。关键问题是：若t检验的显著性水平 $$\alpha = 0.05$$,那么三次比较的显著性水平为$$1 - (1-\alpha)^3 = 0.1426$$,远远超过当初的设定的0.05，犯第一类错误（弃真）概率大大加大。所以对于多样本的均值比较检验，应采用方差分析


#### 方差分析的基本原理

讲到统计学原理之类的东西，总是少不了公式。构建方差分析的基础是F分布，也就是开头见到的那个图。那具体是怎么构建F分布的呢？且看下面推导：

在公式推导前，先上一个表格，有助于对公式的理解。假设一个实验有$$n_j$$个水平（横轴），$$n_i$$个观测样本（纵轴）。实验表格数据如下表所示,一共有$$n_i 行和n_j列$$：

水平| A1|A2|A3|...|\\(A_j\\)|
----|---|--|---|---|---|
1|	\\(X_{11}\\)|	\\(X_{12}\\)|	\\(X_{13}\\)|	…|	\\(X_{1j}\\)|
2|	\\(X_{21}\\)|	\\(X_{22}\\)|	\\(X_{23}\\)|	…|	\\(X_{2j}\\)|
3|	\\(X_{31}\\)|	\\(X_{32}\\)|	\\(X_{33}\\)|	…|	\\(X_{3j}\\)|
…|	\\(X_{…}\\)|	\\(X_{…}\\)|	\\(X_{…}\\)|	…|	\\(X_{…}\\)|
i|	\\(X_{i1}\\)|	\\(X_{i2}\\)|	\\(X_{i3}\\)|	…|	\\(X_{ij}\\)|
列平均值| \\( \overline{X_{.1}}\\)| \\( \overline{X_{.2}}\\)| \\( \overline{X_{.3}}\\)| …| \\( \overline{X_{.j}}\\)|

假设条件：**各个水平 $$A_1,A_2,...,A_j$$ 下样本 $$X_i1,X_i2,...,X_ij$$ 具有相同方差$$\sigma^2$$,且均值$$u_j$$ 和方差$$\sigma^2$$未知的$$n_j$$个正态分布。**

这个假设是一切分析的基础，否则没法做下去了。有了这个假设，接下来就开始推导了。

总偏差平方和：

$$ SST = \sum{ \sum{ (X_{ij} - \overline{X_{..}})^2}} , $$  

其中  

$$  \overline{X_{..}} = \frac{\sum{\sum{X_{ij}}}}{n} . $$

可以分解为： $$ SST = \sum{ \sum{ (X_{ij} - \overline{X_{..}})^2}} = \sum{ \sum{ (X_{ij} - \overline{X_{.j}})^2}} + \sum{ n_i (\overline{X_{.j}} - \overline{X_{..}})^2} $$,  
也就是 $$ SST = SSE + SSA $$ 这就是平方和分解定理。(证明过程略掉感兴趣的自行去推导) 其中,SSE 为误差平方和，SSA为水平效应平方和。

从公式可以看出，误差平方和是 先计算一列的样本观测值与样本平均值的平方和，然后将所有列加起来就是总的误差平方和；效应平方和是先计算列样本均值减去总的均值乘以列数$$n_i$$,然后所有列结果加起来就是总的效应平方和。

这个时候我们要用到了假设的部分，这部分需要知道基本统计分布的性质。每一列的误差($$X_{ij} - \overline{X_{.j}}$$)是服从均值为0，标准差为$$\sigma$$的正态分布 ~$$N(0,\sigma^2)$$ , 那么这一列的误差平方和 服从.

$$ \frac{\sum{ (X_{ij} - \overline{X_{.j}})^2}}{\sigma^2} \sim \chi^2(n_i - 1) $$

自由度为$$n_i$$分布。要减去一个自由度是因为 $$\overline{X_{.1}} = \frac{1}{n_i} \sum(X_{i1})$$，利用了样本信息，故丢失一个自由度。由于卡方分布的可加性，那么所有列的的误差平方和 

$$\frac{SSE}{\sigma^2} \sim \chi^2(n - n_j) ,其中 n=n_i \times  n_j . $$ 

可以知道SSE的期望是 $$E(SSE) = (n-n_i)\sigma^2$$。我们知道两个卡方分布除以各自的自由度的比值服从F分布，现在已经出来了一个卡方分布了，还需要利用SSA构建一个卡方分布。

样本的抽样分布性质可知：

$$ \overline{X_{..}} \sim N( \mu, \frac{\sigma^2}{n} )  $$ 

令：$$ \alpha_j = u_j - u $$ 为水平 $$A_j$$ 的效应，且满足 $$ \sum{n_j} 



#### 双因素

#### 重复测量


### 正确使用步骤




## 实例分析




### 户籍与成绩



### 经济水平与成绩


### 与非参数方法比较





